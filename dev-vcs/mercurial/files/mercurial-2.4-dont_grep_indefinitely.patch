# HG changeset patch
# User Idan Kamara <idankk86@gmail.com>
# Date 1352741223 -7200
# Node ID 35ba170c0f82dba18f0207ef4bd93216e6de8bbf
# Parent  45bd0cd7ca04f8cda0a61cddded8838dd312675a
grep: don't search past the end of the searched string

'*' causes the resulting RE to match 0 or more repetitions of the preceding RE:

>>> bool(re.search('.*', ''))
>>> True

This causes an infinite loop because currently we're only checking if there was
a match without looking at where we are in the searched string.

--- mercurial/commands.py
+++ mercurial/commands.py
@@ -2935,7 +2935,7 @@
     def matchlines(body):
         begin = 0
         linenum = 0
-        while True:
+        while True and begin < len(body):
             match = regexp.search(body, begin)
             if not match:
                 break
--- tests/test-grep.t
+++ tests/test-grep.t
@@ -23,6 +23,10 @@
 
 simple
 
+  $ hg grep '.*'
+  port:4:export
+  port:4:vaportight
+  port:4:import/export
   $ hg grep port port
   port:4:export
   port:4:vaportight

